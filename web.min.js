var Cloudilly=function(){};Cloudilly.prototype.initialize=function(t,e,o){this.app=t,this.access=e,this.socket={},this.tasks={},this.callbacks={},this.pings={},this.attempts=0,this.username="",this.password="",o()},Cloudilly.prototype.connect=function(t,e){var o=this;(!o.socket||0!=o.socket.readyState&&1!=o.socket.readyState)&&(o.username=t,o.password=e,o.reachability.call(o),o.socket=new WebSocket("wss://ws.cloudilly.com"),o.socket.onopen=function(){o.attempts=0,o.getCookie.call(o,"token")?o.connectToken.call(o):o.connectNormal.call(o)},o.socket.onmessage=function(t){if("1"!=t.data){var e=JSON.parse(t.data);switch(e.type){case"reinit":return void o.connectNormal.call(o);case"challenge":return void o.challenge.call(o,e);case"connect":switch(e.status){case"success":return void o.connectSuccess.call(o,e);case"fail":return void o.connectFail.call(o,e)}return;case"task":switch(e.status){case"success":return void o.taskSuccess.call(o,e);case"fail":return void o.taskFail.call(o,e)}return;case"device":return void o.callbacks.device.call(o,e);case"post":return void o.callbacks.post.call(o,e)}}},o.socket.onclose=function(t){return o.attempts=o.attempts+1,clearTimeout(o.pings),o.callbacks.disconnected.call(o),4e3==t.code||o.attempts>100?void(o.attempts=0):void setTimeout(function(){o.connect.call(o,o.username,o.password)},2e3*o.attempts)})},Cloudilly.prototype.disconnect=function(){var t=this,e={};e.type="disconnect";var o=JSON.stringify(e);t.socket.send(o)},Cloudilly.prototype.listen=function(t,e){var o=this,a={};a.type="listen",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.listenWithPassword=function(t,e,o){var a=this,n={};n.type="listen",n.group=t,n.password=e,a.writeAndTask.call(a,n,o)},Cloudilly.prototype.unlisten=function(t,e){var o=this,a={};a.type="unlisten",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.join=function(t,e){var o=this,a={};a.type="join",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.joinWithPassword=function(t,e,o){var a=this,n={};n.type="join",n.group=t,n.password=e,a.writeAndTask.call(a,n,o)},Cloudilly.prototype.unjoin=function(t,e){var o=this,a={};a.type="unjoin",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.update=function(t,e){var o=this,a={};a.type="update",a.payload=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.post=function(t,e,o){var a=this,n={};n.type="post",n.group=t,n.payload=e,a.writeAndTask.call(a,n,o)},Cloudilly.prototype.login=function(t,e,o){var a=this;a.username=t,a.password=e;var n={};n.type="login",n.username=a.username,n.password=a.password,a.writeAndTask.call(a,n,o)},Cloudilly.prototype.logout=function(t){var e=this;delete e.username,delete e.password;var o={};o.type="logout",e.writeAndTask.call(e,o,t)},Cloudilly.prototype.changePassword=function(t,e,o,a){var n=this,s={};s.type="changePassword",s.username=t,s.password=e,s.token=o,n.writeAndTask.call(n,s,a)},Cloudilly.prototype.challenge=function(t){var e=this;e.getToken.call(e,t.device,function(t){e.setCookie.call(e,"token",t,function(){e.connectToken.call(e)})})},Cloudilly.prototype.connectNormal=function(){var t=this;if(t.socket&&1==t.socket.readyState){var e={};e.type="connect",e.app=t.app,e.access=t.access,e.saas="web",e.version=1,t.username&&(e.username=t.username),t.password&&(e.password=t.password);var o=JSON.stringify(e);t.socket.send(o)}},Cloudilly.prototype.connectToken=function(){var t=this;if(t.socket&&1==t.socket.readyState){var e={};e.type="auth",e.app=t.app,e.token=t.getCookie.call(t,"token");var o=JSON.stringify(e);t.socket.send(o)}},Cloudilly.prototype.connectSuccess=function(t){var e=this;e.startPing.call(e),e.callbacks.connected.call(e,null,t)},Cloudilly.prototype.connectFail=function(t){var e=this;e.clearCookie.call(e,"token"),e.callbacks.connected.call(e,1,t)},Cloudilly.prototype.taskSuccess=function(t){var e=this;e.callbacks[t.task].call(e,null,t),delete e.callbacks[t.task],delete e.tasks[t.task]},Cloudilly.prototype.taskFail=function(t){var e=this;e.callbacks[t.task].call(e,1,t),delete e.callbacks[t.task],delete e.tasks[t.task]},Cloudilly.prototype.startPing=function(){var t=this;t.firePing.call(t),t.pings=setInterval(function(){t.firePing.call(t)},15e3)},Cloudilly.prototype.firePing=function(){var t=this;if(t.socket&&1==t.socket.readyState){t.socket.send("1");var e=[];for(var o in t.tasks)e.push([o,t.tasks[o].timestamp]);e.sort(function(t,e){return t[1]<e[1]?1:t[1]>e[1]?-1:0});for(var a=e.length;a--;){var n=t.tasks[e[a][0]];t.socket.send(n.data)}}},Cloudilly.prototype.writeAndTask=function(t,e){var o=this;if(o.socket&&1==o.socket.readyState){var a=Math.round((new Date).getTime()),n=t.type+"-"+o.generateUUID.call();t.task=n,o.callbacks[n]=e;var s={};s.timestamp=a,s.data=JSON.stringify(t),s.task=n,o.tasks[n]=s;var l=JSON.stringify(t);o.socket.send(l)}},Cloudilly.prototype.reachability=function(){var t=this;window.addEventListener("online",function(){t.connect.call(t,t.username,t.password)})},Cloudilly.prototype.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,o="x"===t?e:3&e|8;return o.toString(16)})},Cloudilly.prototype.socketConnected=function(t){this.callbacks.connected=t},Cloudilly.prototype.socketDisconnected=function(t){this.callbacks.disconnected=t},Cloudilly.prototype.socketReceivedDevice=function(t){this.callbacks.device=t},Cloudilly.prototype.socketReceivedPost=function(t){this.callbacks.post=t},Cloudilly.prototype.setCookie=function(t,e,o){var a=new Date(Date.now()+864e5),n="expires="+a.toUTCString();document.cookie=t+"="+e+"; "+n,o()},Cloudilly.prototype.clearCookie=function(t){document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"},Cloudilly.prototype.getCookie=function(t){for(var e=t+"=",o=document.cookie.split(";"),a=0;a<o.length;a++){for(var n=o[a];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(e))return n.substring(e.length,n.length)}},Cloudilly.prototype.getToken=function(t,e){var o=new XMLHttpRequest;o.open("POST","/tokens",!0),o.setRequestHeader("content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4==o.readyState&&200==o.status&&e(o.responseText)},o.send("device="+t)};