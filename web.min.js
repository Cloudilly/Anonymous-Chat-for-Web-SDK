var Cloudilly=function(){this.app={},this.access={},this.socket={},this.tasks={},this.callbacks={},this.pings={},this.attempts=0};Cloudilly.prototype.initialize=function(t,e,o){this.app=t,this.access=e,o()},Cloudilly.prototype.connect=function(t,e){var o=this;o.socket&&1==o.socket.readyState||(o.username=t,o.password=e,o.socket=new WebSocket("wss://ws.cloudilly.com"),o.socket.onopen=function(){o.attempts=0,o.getCookie.call(o,"token")?o.connectToken.call(o):o.connectNormal.call(o)},o.socket.onmessage=function(t){if("1"!=t.data){var e=JSON.parse(t.data);switch(e.type){case"challenge":return void o.challenge.call(o,e);case"connect":switch(e.status){case"success":return void o.connectSuccess.call(o,e);case"fail":return void o.connectFail.call(o,e)}return;case"task":switch(e.status){case"success":return void o.taskSuccess.call(o,e);case"fail":return void o.taskFail.call(o,e)}return;case"device":return void o.callbacks.device.call(o,e);case"post":return void o.callbacks.post.call(o,e)}}},o.socket.onclose=function(t){o.attempts=o.attempts+1,delete o.socket,clearTimeout(o.pings),o.callbacks.disconnected.call(o),1e3!=t.code&&o.attempts<9&&setTimeout(function(){o.connect.call(o,o.username,o.password)},2e3*o.attempts)})},Cloudilly.prototype.login=function(t,e,o){var a=this;a.username=t,a.password=e;var l={};l.type="login",l.username=a.username,l.password=a.password,a.writeAndTask.call(a,l,o)},Cloudilly.prototype.logout=function(t){var e=this;delete e.username,delete e.password;var o={};o.type="logout",e.writeAndTask.call(e,o,t)},Cloudilly.prototype.join=function(t,e){var o=this,a={};a.type="join",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.unjoin=function(t,e){var o=this,a={};a.type="unjoin",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.listen=function(t,e){var o=this,a={};a.type="listen",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.unlisten=function(t,e){var o=this,a={};a.type="unlisten",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.post=function(t,e,o){var a=this,l={};l.type="post",l.group=t,l.payload=e,a.writeAndTask.call(a,l,o)},Cloudilly.prototype.unpost=function(t,e){var o=this,a={};a.type="unpost",a.post=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.update=function(t,e){var o=this,a={};a.type="update",a.payload=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.notify=function(t,e,o){var a=this,l={};l.type="notify",l.message=t,l.group=e,a.writeAndTask.call(a,l,o)},Cloudilly.prototype.email=function(t,e,o,a,l,s){var n=this,i={};i.type="email",i.name=t,i.replyTo=e,i.recipient=o,i.subject=a,i.body=l,n.writeAndTask.call(n,i,s)},Cloudilly.prototype.create=function(t,e,o){var a=this,l={};l.type="create",l.group=t,l.password=e,a.writeAndTask.call(a,l,o)},Cloudilly.prototype.requestPasswordChange=function(t,e){var o=this,a={};a.type="requestPasswordChange",a.group=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype.changePassword=function(t,e,o,a){var l=this,s={};s.type="changePassword",s.group=t,s.password=e,s.random=o,l.writeAndTask.call(l,s,a)},Cloudilly.prototype._createAccount=function(t,e,o,a){var l=this,s={};s.type="_createAccount",s.username=t,s.password=e,s.payload=o,l.writeAndTask.call(l,s,a)},Cloudilly.prototype._generateSecret=function(t){var e=this,o={};o.type="_generateSecret",e.writeAndTask.call(e,o,t)},Cloudilly.prototype._requestSES=function(t){var e=this,o={};o.type="_requestSES",e.writeAndTask.call(e,o,t)},Cloudilly.prototype._createApp=function(t,e){var o=this,a={};a.type="_createApp",a.app=t,o.writeAndTask.call(o,a,e)},Cloudilly.prototype._updatePlan=function(t,e,o){var a=this,l={};l.type="_updatePlan",l.app=t,l.plan=e,a.writeAndTask.call(a,l,o)},Cloudilly.prototype._updateDescription=function(t,e,o){var a=this,l={};l.type="_updateDescription",l.app=t,l.description=e,a.writeAndTask.call(a,l,o)},Cloudilly.prototype._insertValidDomain=function(t,e,o){var a=this,l={};l.type="_insertValidDomain",l.app=t,l.validDomain=e,a.writeAndTask.call(a,l,o)},Cloudilly.prototype._removeValidDomain=function(t,e,o){var a=this,l={};l.type="_removeValidDomain",l.app=t,l.validDomain=e,a.writeAndTask.call(a,l,o)},Cloudilly.prototype._updateAccess=function(t,e,o){var a=this,l={};l.type="_updateAccess",l.app=t,l.saas=e,a.writeAndTask.call(a,l,o)},Cloudilly.prototype._updateBunID=function(t,e,o,a){var l=this,s={};s.type="_updateBunID",s.app=t,s.platform=e,s.bunID=o,l.writeAndTask.call(l,s,a)},Cloudilly.prototype.challenge=function(t){var e=this;e.getToken.call(e,t.device,function(t){e.setCookie.call(e,"token",t,function(){e.connectToken.call(e)})})},Cloudilly.prototype.connectNormal=function(){var t=this;if(!t.socket||1!=t.socket.readyState)return void setTimeout(function(){t.connect.call(t,t.username,t.password)},2e3*t.attempts);var e={};e.type="connect",e.app=t.app,e.access=t.access,e.saas="web",e.version=1,t.username&&(e.username=t.username),t.password&&(e.password=t.password);var o=JSON.stringify(e);t.socket.send(o)},Cloudilly.prototype.connectToken=function(){var t=this;if(!t.socket||1!=t.socket.readyState)return void setTimeout(function(){t.connect.call(t,t.username,t.password)},2e3*t.attempts);var e={};e.type="auth",e.app=t.app,e.token=t.getCookie.call(t,"token");var o=JSON.stringify(e);t.socket.send(o)},Cloudilly.prototype.connectSuccess=function(t){var e=this;e.startPing.call(e),e.callbacks.connected.call(e,null,t)},Cloudilly.prototype.connectFail=function(t){var e=this;e.clearCookie.call(e,"token"),e.callbacks.connected.call(e,1,t)},Cloudilly.prototype.taskSuccess=function(t){var e=this;e.callbacks[t.task].call(e,null,t),delete e.callbacks[t.task],delete e.tasks[t.task]},Cloudilly.prototype.taskFail=function(t){var e=this;e.callbacks[t.task].call(e,1,t),delete e.callbacks[t.task],delete e.tasks[t.task]},Cloudilly.prototype.startPing=function(){var t=this;t.firePing.call(t),t.pings=setInterval(function(){t.firePing.call(t)},15e3)},Cloudilly.prototype.firePing=function(){var t=this;if(!t.socket||1!=t.socket.readyState)return void setTimeout(function(){t.connect.call(t,t.username,t.password)},2e3*t.attempts);t.socket.send("1");var e=[];for(var o in t.tasks)e.push([o,t.tasks[o].timestamp]);e.sort(function(t,e){return t[1]<e[1]?1:t[1]>e[1]?-1:0});for(var a=e.length;a--;){var l=t.tasks[e[a][0]];t.socket.send(l.data)}},Cloudilly.prototype.writeAndTask=function(t,e){var o=this;if(!o.socket||1!=o.socket.readyState)return void setTimeout(function(){o.connect.call(o,o.username,o.password)},2e3*o.attempts);var a=Math.round((new Date).getTime());t.task=t.type+"-"+a,o.callbacks[t.task]=e;var l={};l.timestamp=a,l.data=JSON.stringify(t),l.task=t.task,o.tasks[t.task]=l;var s=JSON.stringify(t);o.socket.send(s)},Cloudilly.prototype.socketConnected=function(t){this.callbacks.connected=t},Cloudilly.prototype.socketDisconnected=function(t){this.callbacks.disconnected=t},Cloudilly.prototype.socketReceivedDevice=function(t){this.callbacks.device=t},Cloudilly.prototype.socketReceivedPost=function(t){this.callbacks.post=t},Cloudilly.prototype.setCookie=function(t,e,o){document.cookie=t+"="+e+"; ",o()},Cloudilly.prototype.clearCookie=function(t){document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"},Cloudilly.prototype.getCookie=function(t){for(var e=t+"=",o=document.cookie.split(";"),a=0;a<o.length;a++){for(var l=o[a];" "==l.charAt(0);)l=l.substring(1);if(0==l.indexOf(e))return l.substring(e.length,l.length)}},Cloudilly.prototype.getToken=function(t,e){var o=this,a=new XMLHttpRequest;a.open("POST","/tokens",!0),a.setRequestHeader("CONTENT-TYPE","APPLICATION/X-WWW-FORM-URLENCODED"),a.onload=function(){e(JSON.parse(this.responseText))},a.send("device="+t+"&cookie="+o.getCookie.call(o,"cloudilly"))};