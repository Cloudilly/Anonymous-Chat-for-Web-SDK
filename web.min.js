var Cloudilly=function(){this.app={},this.access={},this.socket={},this.tasks={},this.callbacks={},this.pings={},this.attempts=0};Cloudilly.prototype.initialize=function(t,e,o){this.app=t,this.access=e,o()},Cloudilly.prototype.connect=function(t,e){var o=this;o.socket&&1==o.socket.readyState||(o.username=t,o.password=e,o.socket=new WebSocket("wss://ws.cloudilly.com"),o.socket.onopen=function(){o.attempts=0,o.getCookie.call(o,"token")?o.connectToken.call(o):o.connectNormal.call(o)},o.socket.onmessage=function(t){if("1"!=t.data){var e=JSON.parse(t.data);switch(e.type){case"reinit":return void o.connectNormal.call(o);case"challenge":return void o.challenge.call(o,e);case"connect":switch(e.status){case"success":return void o.connectSuccess.call(o,e);case"fail":return void o.connectFail.call(o,e)}return;case"task":switch(e.status){case"success":return void o.taskSuccess.call(o,e);case"fail":return void o.taskFail.call(o,e)}return;case"device":return void o.callbacks.device.call(o,e);case"post":return void o.callbacks.post.call(o,e)}}},o.socket.onerror=function(t){o.attempts=o.attempts+1,delete o.socket,clearTimeout(o.pings),o.callbacks.disconnected.call(o),4e3!=t.code&&o.attempts<100&&setTimeout(function(){o.connect.call(o,o.username,o.password)},2e3*o.attempts)},o.socket.onclose=function(t){o.attempts=o.attempts+1,delete o.socket,clearTimeout(o.pings),o.callbacks.disconnected.call(o),4e3!=t.code&&o.attempts<100&&setTimeout(function(){o.connect.call(o,o.username,o.password)},2e3*o.attempts)})},Cloudilly.prototype.disconnect=function(){var t=this,e={};e.type="disconnect";var o=JSON.stringify(e);t.socket.send(o)},Cloudilly.prototype.listen=function(t,e){var o=this,s={};s.type="listen",s.group=t,o.writeAndTask.call(o,s,e)},Cloudilly.prototype.unlisten=function(t,e){var o=this,s={};s.type="unlisten",s.group=t,o.writeAndTask.call(o,s,e)},Cloudilly.prototype.join=function(t,e){var o=this,s={};s.type="join",s.group=t,o.writeAndTask.call(o,s,e)},Cloudilly.prototype.unjoin=function(t,e){var o=this,s={};s.type="unjoin",s.group=t,o.writeAndTask.call(o,s,e)},Cloudilly.prototype.post=function(t,e,o){var s=this,a={};a.type="post",a.group=t,a.payload=e,s.writeAndTask.call(s,a,o)},Cloudilly.prototype.create=function(t,e,o){var s=this,a={};a.type="create",a.username=t,a.password=e,s.writeAndTask.call(s,a,o)},Cloudilly.prototype.login=function(t,e,o){var s=this;s.username=t,s.password=e;var a={};a.type="login",a.username=s.username,a.password=s.password,s.writeAndTask.call(s,a,o)},Cloudilly.prototype.logout=function(t){var e=this;delete e.username,delete e.password;var o={};o.type="logout",e.writeAndTask.call(e,o,t)},Cloudilly.prototype.update=function(t,e){var o=this,s={};s.type="update",s.payload=t,o.writeAndTask.call(o,s,e)},Cloudilly.prototype.store=function(t,e,o){var s=this,a={};a.type="store",a.group=t,a.payload=e,s.writeAndTask.call(s,a,o)},Cloudilly.prototype.remove=function(t,e){var o=this,s={};s.type="remove",s.post=t,o.writeAndTask.call(o,s,e)},Cloudilly.prototype.notify=function(t,e,o){var s=this,a={};a.type="notify",a.message=t,a.group=e,s.writeAndTask.call(s,a,o)},Cloudilly.prototype.email=function(t,e,o,s,a,l){var n=this,c={};c.type="email",c.name=t,c.replyTo=e,c.recipient=o,c.subject=s,c.body=a,n.writeAndTask.call(n,c,l)},Cloudilly.prototype.requestPasswordChange=function(t,e){var o=this,s={};s.type="requestPasswordChange",s.username=t,o.writeAndTask.call(o,s,e)},Cloudilly.prototype.changePassword=function(t,e,o,s){var a=this,l={};l.type="changePassword",l.username=t,l.password=e,l.random=o,a.writeAndTask.call(a,l,s)},Cloudilly.prototype.challenge=function(t){var e=this;e.getToken.call(e,t.device,function(t){e.setCookie.call(e,"token",t,function(){e.connectToken.call(e)})})},Cloudilly.prototype.connectNormal=function(){var t=this;if(t.socket&&1==t.socket.readyState){var e={};e.type="connect",e.app=t.app,e.access=t.access,e.saas="web",e.version=1,t.username&&(e.username=t.username),t.password&&(e.password=t.password);var o=JSON.stringify(e);t.socket.send(o)}},Cloudilly.prototype.connectToken=function(){var t=this;if(t.socket&&1==t.socket.readyState){var e={};e.type="auth",e.app=t.app,e.token=t.getCookie.call(t,"token");var o=JSON.stringify(e);t.socket.send(o)}},Cloudilly.prototype.connectSuccess=function(t){var e=this;e.startPing.call(e),e.callbacks.connected.call(e,null,t)},Cloudilly.prototype.connectFail=function(t){var e=this;e.clearCookie.call(e,"token"),e.callbacks.connected.call(e,1,t)},Cloudilly.prototype.taskSuccess=function(t){var e=this;e.callbacks[t.task].call(e,null,t),delete e.callbacks[t.task],delete e.tasks[t.task]},Cloudilly.prototype.taskFail=function(t){var e=this;e.callbacks[t.task].call(e,1,t),delete e.callbacks[t.task],delete e.tasks[t.task]},Cloudilly.prototype.startPing=function(){var t=this;t.firePing.call(t),t.pings=setInterval(function(){t.firePing.call(t)},15e3)},Cloudilly.prototype.firePing=function(){var t=this;if(t.socket&&1==t.socket.readyState){t.socket.send("1");var e=[];for(var o in t.tasks)e.push([o,t.tasks[o].timestamp]);e.sort(function(t,e){return t[1]<e[1]?1:t[1]>e[1]?-1:0});for(var s=e.length;s--;){var a=t.tasks[e[s][0]];t.socket.send(a.data)}}},Cloudilly.prototype.writeAndTask=function(t,e){var o=this;if(o.socket&&1==o.socket.readyState){var s=Math.round((new Date).getTime());t.task=t.type+"-"+s,o.callbacks[t.task]=e;var a={};a.timestamp=s,a.data=JSON.stringify(t),a.task=t.task,o.tasks[t.task]=a;var l=JSON.stringify(t);o.socket.send(l)}},Cloudilly.prototype.socketConnected=function(t){this.callbacks.connected=t},Cloudilly.prototype.socketDisconnected=function(t){this.callbacks.disconnected=t},Cloudilly.prototype.socketReceivedDevice=function(t){this.callbacks.device=t},Cloudilly.prototype.socketReceivedPost=function(t){this.callbacks.post=t},Cloudilly.prototype.setCookie=function(t,e,o){document.cookie=t+"="+e+"; ",o()},Cloudilly.prototype.clearCookie=function(t){document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"},Cloudilly.prototype.getCookie=function(t){for(var e=t+"=",o=document.cookie.split(";"),s=0;s<o.length;s++){for(var a=o[s];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(e))return a.substring(e.length,a.length)}},Cloudilly.prototype.getToken=function(t,e){var o=this,s=new XMLHttpRequest;s.open("POST","/tokens",!0),s.setRequestHeader("CONTENT-TYPE","APPLICATION/X-WWW-FORM-URLENCODED"),s.onload=function(){e(JSON.parse(this.responseText))},s.send("device="+t+"&cookie="+o.getCookie.call(o,"cloudilly"))};