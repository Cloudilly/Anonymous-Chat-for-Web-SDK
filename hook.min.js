var WebSocket=require("ws");module.exports={initialize:function(t,s,e){this.app=t,this.access=s,this.socket={},this.tasks={},this.callbacks={},this.pings={},this.attempts=0,this.username="",this.password="",e()},connect:function(t,s){var e=this;e.socket&&1==this.socket.readyState||(e.username=t,e.password=s,e.socket=new WebSocket("wss://ws.cloudilly.com"),e.socket.onopen=function(){e.attempts=0,e.connectNormal.call(e)},e.socket.onmessage=function(t){if("1"!=t.data){var s=JSON.parse(t.data);switch(s.type){case"connect":switch(s.status){case"success":return void e.connectSuccess.call(e,s);case"fail":return void e.connectFail.call(e,s)}return;case"task":switch(s.status){case"success":return void e.taskSuccess.call(e,s);case"fail":return void e.taskFail.call(e,s)}return;case"device":return void e.callbacks.device.call(e,s);case"post":return void e.callbacks.post.call(e,s)}}},e.socket.onclose=function(t){e.attempts=e.attempts+1,delete e.socket,clearTimeout(e.pings),e.callbacks.disconnected.call(e),1e3!=t.code&&e.attempts<9&&setTimeout(function(){e.connect.call(e,e.username,e.password)},2e3*e.attempts)})},login:function(t,s,e){var a=this;a.username=t,a.password=s;var n={};n.type="login",n.username=a.username,n.password=a.password,a.writeAndTask.call(a,n,e)},logout:function(t){var s=this,e={};e.type="logout",s.writeAndTask.call(s,e,t)},join:function(t,s){var e=this,a={};a.type="join",a.group=t,e.writeAndTask.call(e,a,s)},unjoin:function(t,s){var e=this,a={};a.type="unjoin",a.group=t,e.writeAndTask.call(e,a,s)},listen:function(t,s){var e=this,a={};a.type="listen",a.group=t,e.writeAndTask.call(e,a,s)},unlisten:function(t,s){var e=this,a={};a.type="unlisten",a.group=t,e.writeAndTask.call(e,a,s)},post:function(t,s,e){var a=this,n={};n.type="post",n.group=t,n.payload=s,a.writeAndTask.call(a,n,e)},unpost:function(t,s){var e=this,a={};a.type="unpost",a.post=t,e.writeAndTask.call(e,a,s)},update:function(t,s){var e=this,a={};a.type="update",a.payload=t,e.writeAndTask.call(e,a,s)},notify:function(t,s,e){var a=this,n={};n.type="notify",n.message=t,n.group=s,a.writeAndTask.call(a,n,e)},create:function(t,s,e){var a=this,n={};n.type="create",n.username=t,n.password=s,a.writeAndTask.call(a,n,e)},requestPasswordChange:function(t,s){var e=this,a={};a.type="requestPasswordChange",a.group=t,e.writeAndTask.call(e,a,s)},_requestPasswordChange:function(t,s,e){var a=this,n={};n.type="_requestPasswordChange",n.app=t,n.group=s,a.writeAndTask.call(a,n,e)},changePassword:function(t,s,e,a){var n=this,c={};c.type="changePassword",c.group=t,c.password=s,c.random=e,n.writeAndTask.call(n,c,a)},_changePassword:function(t,s,e,a,n){var c=this,i={};i.type="_changePassword",i.app=t,i.group=s,i.password=e,i.random=a,c.writeAndTask.call(c,i,n)},email:function(t,s,e,a,n,c){var i=this,o={};o.type="email",o.name=t,o.replyTo=s,o.recipient=e,o.subject=a,o.body=n,i.writeAndTask.call(i,o,c)},_updatePlatform:function(t,s,e,a,n){var c=this,i={};i.type="_updatePlatform",i.app=t,i.device=s,i.platform=e,i.arn=a,c.writeAndTask.call(c,i,n)},_verifyAccount:function(t,s,e){var a=this,n={};n.type="_verifyAccount",n.username=t,n.accountID=s,a.writeAndTask.call(a,n,e)},connectNormal:function(){var t=this;if(!t.socket||1!=t.socket.readyState)return void setTimeout(function(){t.connect.call(t,t.username,t.password)},2e3*t.attempts);var s={};s.type="connect",s.app=t.app,s.access=t.access,s.saas="hook",s.version=1,t.username&&(s.username=t.username),t.password&&(s.password=t.password);var e=JSON.stringify(s);t.socket.send(e)},connectSuccess:function(t){var s=this;s.startPing.call(s),s.callbacks.connected.call(s,null,t)},connectFail:function(t){var s=this;s.callbacks.connected.call(s,1,t)},taskSuccess:function(t){var s=this;s.callbacks[t.task].call(s,null,t),delete s.callbacks[t.task],delete s.tasks[t.task]},taskFail:function(t){var s=this;s.callbacks[t.task].call(s,1,t),delete s.callbacks[t.task],delete s.tasks[t.task]},startPing:function(){var t=this;t.firePing.call(t),t.pings=setInterval(function(){t.firePing.call(t)},15e3)},firePing:function(){var t=this;if(!t.socket||1!=t.socket.readyState)return void setTimeout(function(){t.connect.call(t,username,password)},2e3*t.attempts);t.socket.send("1");var s=[];for(var e in t.tasks)s.push([e,t.tasks[e].timestamp]);s.sort(function(t,s){return t[1]<s[1]?1:t[1]>s[1]?-1:0});for(var a=s.length;a--;){var n=t.tasks[s[a][0]];t.socket.send(n.data)}},writeAndTask:function(t,s){var e=this;if(!e.socket||1!=e.socket.readyState)return void setTimeout(function(){e.connect.call(e,username,password)},2e3*e.attempts);var a=Math.round((new Date).getTime());t.task=t.type+"-"+a,e.callbacks[t.task]=s;var n={};n.timestamp=a,n.data=JSON.stringify(t),n.task=t.task,e.tasks[t.task]=n;var c=JSON.stringify(t);e.socket.send(c)},socketConnected:function(t){this.callbacks.connected=t},socketDisconnected:function(t){this.callbacks.disconnected=t},socketReceivedDevice:function(t){this.callbacks.device=t},socketReceivedPost:function(t){this.callbacks.post=t}};