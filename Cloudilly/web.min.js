var Cloudilly=function(){};Cloudilly.prototype.initialize=function(t,e,o){this.app=t,this.access=e,this.socket={},this.tasks={},this.callbacks={},this.ping={},this.pong={},this.attempts=0,this.username="",this.password="",o()},Cloudilly.prototype.connect=function(t,e){var o=this;(!o.socket||0!=o.socket.readyState&&1!=o.socket.readyState)&&(o.username=t,o.password=e,o.reachability.call(o),o.socket=new WebSocket("wss://ws.cloudilly.com"),o.socket.onopen=function(){o.attempts=0,o.getCookie.call(o,"token")?o.connectToken.call(o):o.connectNormal.call(o)},o.socket.onmessage=function(t){if("1"==t.data)return void o.stopPong.call(o);var e=JSON.parse(t.data);switch(e.type){case"reinit":return void o.connectNormal.call(o);case"challenge":return void o.challenge.call(o,e);case"connect":switch(e.status){case"success":return void o.connectSuccess.call(o,e);case"fail":return void o.connectFail.call(o,e)}return;case"task":switch(e.status){case"success":return void o.taskSuccess.call(o,e);case"fail":return void o.taskFail.call(o,e)}return;case"device":return void o.callbacks.device.call(o,e);case"post":return void o.callbacks.post.call(o,e)}},o.socket.onclose=function(t){return o.attempts=o.attempts+1,clearTimeout(o.ping),o.callbacks.disconnected.call(o),4e3==t.code||o.attempts>100?void(o.attempts=0):void setTimeout(function(){o.connect.call(o,o.username,o.password)},2e3*o.attempts)})},Cloudilly.prototype.disconnect=function(){var t=this,e={};e.type="disconnect";var o=JSON.stringify(e);t.socket.send(o)},Cloudilly.prototype.listen=function(t,e){var o=this,n={};n.type="listen",n.group=t,o.writeAndTask.call(o,n,e)},Cloudilly.prototype.listenWithPassword=function(t,e,o){var n=this,a={};a.type="listen",a.group=t,a.password=e,n.writeAndTask.call(n,a,o)},Cloudilly.prototype.unlisten=function(t,e){var o=this,n={};n.type="unlisten",n.group=t,o.writeAndTask.call(o,n,e)},Cloudilly.prototype.join=function(t,e){var o=this,n={};n.type="join",n.group=t,o.writeAndTask.call(o,n,e)},Cloudilly.prototype.joinWithPassword=function(t,e,o){var n=this,a={};a.type="join",a.group=t,a.password=e,n.writeAndTask.call(n,a,o)},Cloudilly.prototype.unjoin=function(t,e){var o=this,n={};n.type="unjoin",n.group=t,o.writeAndTask.call(o,n,e)},Cloudilly.prototype.update=function(t,e){var o=this,n={};n.type="update",n.payload=t,o.writeAndTask.call(o,n,e)},Cloudilly.prototype.post=function(t,e,o){var n=this,a={};a.type="post",a.group=t,a.payload=e,n.writeAndTask.call(n,a,o)},Cloudilly.prototype.login=function(t,e,o){var n=this;n.username=t,n.password=e;var a={};a.type="login",a.username=n.username,a.password=n.password,n.writeAndTask.call(n,a,o)},Cloudilly.prototype.logout=function(t){var e=this;delete e.username,delete e.password;var o={};o.type="logout",e.writeAndTask.call(e,o,t)},Cloudilly.prototype.changePassword=function(t,e,o,n){var a=this,l={};l.type="changePassword",l.group=t,l.password=e,l.token=o,a.writeAndTask.call(a,l,n)},Cloudilly.prototype.challenge=function(t){var e=this;e.getToken.call(e,t.device,function(t){e.setCookie.call(e,"token",t,function(){e.connectToken.call(e)})})},Cloudilly.prototype.connectNormal=function(){var t=this;if(t.socket&&1==t.socket.readyState){var e={};e.type="connect",e.app=t.app,e.access=t.access,e.saas="web",e.version=1,t.username&&(e.username=t.username),t.password&&(e.password=t.password);var o=JSON.stringify(e);t.socket.send(o)}},Cloudilly.prototype.connectToken=function(){var t=this;if(t.socket&&1==t.socket.readyState){var e={};e.type="auth",e.app=t.app,e.token=t.getCookie.call(t,"token");var o=JSON.stringify(e);t.socket.send(o)}},Cloudilly.prototype.connectSuccess=function(t){var e=this;e.startPing.call(e),e.callbacks.connected.call(e,null,t)},Cloudilly.prototype.connectFail=function(t){var e=this;e.clearCookie.call(e,"token"),e.callbacks.connected.call(e,1,t)},Cloudilly.prototype.taskSuccess=function(t){var e=this;e.callbacks[t.task]&&(e.callbacks[t.task].call(e,null,t),delete e.callbacks[t.task],delete e.tasks[t.task])},Cloudilly.prototype.taskFail=function(t){var e=this;e.callbacks[t.task]&&(e.callbacks[t.task].call(e,1,t),delete e.callbacks[t.task],delete e.tasks[t.task])},Cloudilly.prototype.startPing=function(){var t=this;t.firePing.call(t),t.ping=setInterval(function(){t.firePing.call(t)},15e3)},Cloudilly.prototype.firePing=function(){var t=this;if(t.socket&&1==t.socket.readyState){t.socket.send("1"),t.startPong.call(t);var e=[];for(var o in t.tasks)e.push([o,t.tasks[o].timestamp]);e.sort(function(t,e){return t[1]<e[1]?1:t[1]>e[1]?-1:0});for(var n=e.length;n--;){var a=t.tasks[e[n][0]];t.socket.send(a.data)}}},Cloudilly.prototype.startPong=function(){var t=this;t.pong&&(clearTimeout(t.pong),t.pong=null),t.pong=setTimeout(function(){t.firePong.call(t)},5e3)},Cloudilly.prototype.stopPong=function(){var t=this;t.pong&&(clearTimeout(t.pong),t.pong=null)},Cloudilly.prototype.firePong=function(){self.socket.close()},Cloudilly.prototype.writeAndTask=function(t,e){var o=this;if(o.socket&&1==o.socket.readyState){var n=Math.round((new Date).getTime()),a=t.type+"-"+o.generateUUID.call();t.task=a,o.callbacks[a]=e;var l={};l.timestamp=n,l.data=JSON.stringify(t),l.task=a,o.tasks[a]=l;var s=JSON.stringify(t);o.socket.send(s)}},Cloudilly.prototype.reachability=function(){var t=this;window.addEventListener("online",function(e){t.connect.call(t,t.username,t.password)})},Cloudilly.prototype.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,o="x"===t?e:3&e|8;return o.toString(16)})},Cloudilly.prototype.socketConnected=function(t){this.callbacks.connected=t},Cloudilly.prototype.socketDisconnected=function(t){this.callbacks.disconnected=t},Cloudilly.prototype.socketReceivedDevice=function(t){this.callbacks.device=t},Cloudilly.prototype.socketReceivedPost=function(t){this.callbacks.post=t},Cloudilly.prototype.setCookie=function(t,e,o){var n=new Date(Date.now()+864e5),a="expires="+n.toUTCString(),l="path=/";document.cookie=t+"="+e+"; "+a+";"+l+";",o()},Cloudilly.prototype.clearCookie=function(t){document.cookie=t+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"},Cloudilly.prototype.getCookie=function(t){for(var e=t+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(var a=o[n];" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(e))return a.substring(e.length,a.length)}},Cloudilly.prototype.getToken=function(t,e){var o=new XMLHttpRequest;o.open("POST","/tokens",!0),o.setRequestHeader("content-type","application/x-www-form-urlencoded"),o.onreadystatechange=function(){4==o.readyState&&200==o.status&&e(o.responseText)},o.send("device="+t)};